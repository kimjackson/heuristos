<html>
 <head>
  <script src="/h3/hapi/hapiLoader.php"></script>
  <script>

	var record;
	var record_type;
	var detail_types;

	function init() {

		record_type = HRecordTypeManager.getRecordTypeById(151);
		detail_types = HDetailManager.getDetailTypesForRecordType(record_type);

		// fill in Type options
		var opt;
		for (var i in detail_types) {
			if (detail_types[i].getID() == 523) {	// entity type
				var enum_vals = detail_types[i].getEnumerationValues();
				for (var v in enum_vals) {
					opt = document.getElementById("type").appendChild(document.createElement("option"));
					opt.value = opt.innerHTML = enum_vals[v];
				}
			}
		}

		var matches = window.location.href.match(/[?&]id=([0-9]+)/);
		if (matches) {
			load_annotation(matches[1]);
		} else {
			fill_form();
		}
	}

	function load_annotation(id) {
		var loader = new HLoader(
			function(s,r) {
				record = r[0];
				annotation_loaded();
			},
			function(s,e) {
				alert("load failed: " + e);
			});
		HeuristScholarDB.loadRecords(new HSearch("id:" + id), loader);
	}

	function annotation_loaded() {
		for (var i in detail_types) {
			var val = record.getDetail(detail_types[i]);
			switch (detail_types[i].getID()) {
				case 160: document.getElementById("title").value = val; break;
				case 191: document.getElementById("notes").value = val; break;
				case 322: break; // tei document reference - no need to load
				case 323: document.getElementById("start_d").value = val; break;
				case 324: document.getElementById("end_d").value = val; break;
				case 325: document.getElementById("start_p").value = val; break;
				case 326: document.getElementById("end_p").value = val; break;
				case 327: document.getElementById("start_s").value = val; break;
				case 328: document.getElementById("end_s").value = val; break;
				case 329: document.getElementById("start_w").value = val; break;
				case 330: document.getElementById("end_w").value = val; break;
				case 359: document.getElementById("type").value = val; break;
				case 152: setLinkedRecord(val.getID(), val.getTitle()); break;
			}
		}
	}


	function fill_form() {

		var matches = window.location.href.match(/[?&]refid=([0-9]+)/);
		if (matches) {
			related_id = matches[1];
		}

		matches = window.location.href.match(/[?&]type=([a-z]+)/);
		if (matches) {
			annotation_type = matches[1];
		} else {
			annotation_type = "entity";
		}

		// disable section inputs
		document.getElementById("start_p").disabled = true;
		document.getElementById("end_p").disabled = true;
		document.getElementById("start_s").disabled = true;
		document.getElementById("end_s").disabled = true;
		document.getElementById("start_w").disabled = true;
		document.getElementById("end_w").disabled = true;

		var root = window.opener.document.getElementById("tei");
		ref = window.opener.getSelectionAddress(root);
		if (ref) {
			document.getElementById("start_d").value = ref.startElems[0];
			document.getElementById("start_p").value = ref.startElems[1];
			document.getElementById("start_s").value = ref.startElems[2];
			document.getElementById("start_w").value = ref.startWord;
			if (ref.endElems[0] != ref.startElems[0])
				document.getElementById("end_d").value = ref.endElems[0];
			if (ref.endElems[1] != ref.startElems[1])
				document.getElementById("end_p").value = ref.endElems[1];
			if (ref.endElems[2] != ref.startElems[2])
				document.getElementById("end_s").value = ref.endElems[2];
			if (ref.endWord != ref.startWord)
				document.getElementById("end_w").value = ref.endWord;
		}

		// WARNING BRITTLE CODE BELOW
		// If the enum values for annotation type are changed this will break.
		// There's no other way to do it though.
		switch (annotation_type) {
		case "entity":
			document.getElementById("type").value = "Annotation - Entity";
			break;
		case "term":
			document.getElementById("type").value = "Annotation - Term";
			break;
		case "multimedia":
			document.getElementById("type").value = "Annotation - MM";
			break;
		case "text":
			document.getElementById("type").value = "Annotation - Essay";
			break;
		}

		var refdoc_title;
		try {
			refdoc_title = window.opener.getSelection().toString();
		} catch (e) { }

		if (annotation_type == "entity") {
			document.getElementById("search").value = refdoc_title;
		} else {
			document.getElementById("title").value = refdoc_title;
		}


		var loader = new HLoader(
			function(s,r) {
				related = r[0];
			},
			function(s,e) {
				alert("load failed: " + e);
			});
		HeuristScholarDB.loadRecords(new HSearch("id:" + related_id), loader);
	}


	function saveRecord() {
		if (! record) {
			record = new HRecord();
			record.setRecordType(record_type);

			if (related.getWorkgroup()) {
				record.setWorkgroup(related.getWorkgroup());
				record.setNonWorkgroupVisible(true);
			}

		}

		var start_d = document.getElementById("start_d").value;
		var end_d = document.getElementById("end_d").value;
		var start_p = document.getElementById("start_p").value;
		var end_p = document.getElementById("end_p").value;
		var start_s = document.getElementById("start_s").value;
		var end_s = document.getElementById("end_s").value;
		var start_w = document.getElementById("start_w").value;
		var end_w = document.getElementById("end_w").value;

		for (var i in detail_types) {
			var val = null;
			switch (detail_types[i].getID()) {
				case 160: val = document.getElementById("title").value; break;
				case 191: val = document.getElementById("notes").value; break;
				case 322: val = related; break;
				case 323: val = start_d; break;
				case 324: val = end_d != start_d ? end_d : null; break;
				case 325: val = start_p; break;
				case 326: val = end_p != start_p ? end_p : null; break;
				case 327: val = start_s; break;
				case 328: val = end_s != start_s ? end_s : null; break;
				case 329: val = start_w; break;
				case 330: val = end_w != start_w ? end_w : null; break;
				case 359: val = document.getElementById("type").value; break;
				case 152: val = linked_record; break;
			}

			if (val)
				record.setDetails(detail_types[i], [val]);
		}

		var saver = new HSaver(
			function(r) {
				if (window.opener) {
					window.opener.location.reload();
					setTimeout(window.close, 10);
				}
			},
			function(r,e) {
				alert("record save failed: " + e);
			});

		HeuristScholarDB.saveRecord(record, saver);
	}

  </script>
 </head>
  <title>Add / edit entity</title>

 <body onload="init();">

  <h2>Add / edit entity</h2>

  <table cellspacing=10px>
   <tr>
    <td>Title</td><td colspan=3><input type=text id=title style="width: 60ex;"/></td>
   </tr>
   <tr>
    <td>Notes</td><td colspan=3><textarea id=notes style="width: 60ex;"></textarea></td>
   </tr>
   <tr>
    <td>Entity Type</td><td colspan=3><select id=type style="width: 30ex;"></select></td>
   </tr>
   <tr>
    <td>Fictional?</td><td colspan=3><input type=checkbox id=fictional></input></td>
   </tr>
   <tr>
    <td>Gender</td>
	<td colspan=3>
	 <select id=gender>
      <option></option>
      <option value="F">F</option>
      <option value="M">M</option>
	 </select>
     <span style="font-size: 70%;">Only for people!</span>
    </td>
   </tr>
   <tr>
    <td><input type=button value=save onclick="saveRecord();"/></td>
   </tr>
  </table>

 </body>
</html>
